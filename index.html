<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
		<title>tt2raid</title>
		<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.0/vue.min.js"></script>
		<script src="https://cdn.staticfile.org/dom-to-image/2.6.0/dom-to-image.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
		<style>
			*{
				font-family: "Microsoft Yahei";
			}
			i{
				display: inline-block;
				font-style: normal;
			}
			html{
				font-size: 10px;
			}
			html,body{
				margin: 0;
			}
			body{
				background-color: #F6F6F6;
			}
			input,button,textarea{ border: none; background: transparent; vertical-align:middle; outline: none; overflow: visible;
				-webkit-user-select: auto;
			}
			table{
				border-collapse:collapse;
				border-spacing:0;
			}
			th{
				text-align: left;
			}
			th,td{
				padding: 0.5rem 1rem;
				border: 1px solid #D4D4D4;
				font-size: 1.6rem;
				background-color: #FFFFFF;
			}
			button{
				border: 1px solid #D4D4D4;
				border-radius: 1rem;
				cursor: pointer;
			}
			button.imp{
				color: #FFFFFF;
				background-color: #3399FF;
			}
			.anisn{
				-webkit-touch-callout:none;
				-webkit-user-select:none;
				-khtml-user-select:none;
				-moz-user-select:none;
				-ms-user-select:none;
				user-select:none;
				-o-user-select:none;
			}
			.anisa{
				-webkit-touch-callout:text;
				-webkit-user-select:text;
				-khtml-user-select:text;
				-moz-user-select:text;
				-ms-user-select:text;
				user-select:text;
				-moz-user-select:text;
			}
			.anitran1 *{
				-webkit-transition: none;
				-moz-transition: none;
				-o-transition: none;
				transition: none;
			}
			.anitran1{
				-webkit-transition: all 0.1s ease-out;
				-moz-transition: all 0.1s ease-out;
				-o-transition: all 0.1s ease-out;
				transition: all 0.1s ease-out;
			}
			.header{
				display: flex;
				align-items: center;
				padding: 0 2rem;
				font-size: 1.6rem;
				background-color: #D4D4D4;
			}
			.header .title{
				margin-right: 1rem;
			}
			.header .tab{
				position: relative;
				margin-top: 1rem;
				padding: 0 1.5rem;
				padding-top: 0.5rem;
				padding-bottom: 1rem;
				border-top-left-radius: 1rem;
				border-top-right-radius: 1rem;
				cursor: pointer;
			}
			.header .tab .b{
				position: absolute;
				bottom: 0;
				width: 1rem;
				height: 1rem;
				background-color: #F6F6F6;
				opacity: 0;
			}
			.header .tab .b.l{
				left: -1rem;
			}
			.header .tab .b.r{
				right: -1rem;
			}
			.header .tab .c{
				display: block;
				height: 100%;
				background-color: #D4D4D4;
			}
			.header .tab.active{
				background-color: #F6F6F6;
				box-shadow: 0 -0.2rem 0.2rem rgba(0, 0, 0, 0.2);
			}
			.header .tab.active .b{
				opacity: 1;
			}
			.header .tab.active .b.l .c{
				border-bottom-right-radius: 1rem;
			}
			.header .tab.active .b.r .c{
				border-bottom-left-radius: 1rem;
			}
			.header .blank{
				flex: 1;
			}
			
			.logo{
				position: fixed;
				left: 2rem;
				bottom: 2rem;
				font-size: 2rem;
				color: #B2B2B2;
				z-index: -1;
				pointer-events: none;
			}
			
			.inputbox{
				padding: 2rem;
			}
			.input{
				display: block;
				width: calc(100% - 2.4rem);
				height: 20rem;
				padding: 1rem;
				resize: none;
				border: 0.2rem solid #B2B2B2;
				border-radius: 1rem;
			}
			.input:focus{
				border-color: #3399FF;
			}
			td[color="1"]{
				background-color: #3399FF;
			}
			td[color="-1"]{
				background-color: #EE5555;
			}
			th.cp{
				cursor: pointer;
			}
			th.im{
				color: #3399FF;
			}
			.control{
				display: flex;
				align-items: center;
				padding: 0 1rem;
				margin-top: 1rem;
			}
			.control span{
				font-size: 1.6rem;
				margin: 0 1rem;
				white-space: nowrap;
			}
			.control .btn{
				width: 12rem;
				height: 4rem;
				margin: 0 1rem;
			}
			.control .text{
				box-sizing: border-box;
				width: 100%;
				height: 4rem;
				padding: 0 0.5rem;
				margin: 0 1rem;
				border: 0.2rem solid #B2B2B2;
				border-radius: 1rem;
			}
			.control .text:focus{
				border-color: #3399FF;
			}
			.tablebox{
				position: relative;
				margin-top: 2rem;
				margin-bottom: 8rem;
			}
			.tablebox .blank{
				margin-top: 2rem;
				font-size: 1.6rem;
				color: #999999;
				text-align: center;
			}
			.table{
				margin: 0 2rem;
				overflow: auto;
			}
			.table table{
				/* table-layout: fixed; */
			}
			.table.poa{
				position: absolute;
			}
			.table.poa table{
				table-layout: fixed;
				width: 12rem;
			}
			.table.poa2{
				position: fixed;
				top: 0;
				left: 0;
			}
			.table .poa2_2{
				margin-left: calc(12rem - 1px);
			}
			.table.por{
				margin-left: calc(14rem - 1px);
			}
			.table .cu{
				font-size: 1.2rem;
				color: #3399FF;
				font-weight: bold;
			}
			.table .cd{
				font-size: 1.2rem;
				color: #EE5555;
				font-weight: bold;
			}
			.table .ns{
				opacity: 0;
				/* width: 12rem; */
			}
			.table th{
				background-color: #F6F6F6;
			}
			.table th,.table td{
				white-space: nowrap;
				height: 3rem;
			}
			.table th.ns,.table td.ns{
				/* width: 12rem; */
			}
			.table td{
				/* word-break: break-all; */
			}
			.table.poa th,.table.poa td{
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
			}
			.hint{
				margin-top: 1rem;
				padding: 0 2rem;
				font-size: 1.6rem;
				margin-bottom: 1rem;
			}
			
			.introcon{
				margin-bottom: 4rem;
			}
			.introcon .p{
				margin-top: 2rem;
				padding: 0 2rem;
				font-size: 1.6rem;
			}
			.introcon .h2{
				margin: 0 2rem;
				margin-top: 2rem;
				padding-top: 2rem;
				font-size: 2rem;
				font-weight: bold;
				color: #999999;
				border-top: 1px solid #D4D4D4;
			}
			.introcon>div:first-child .h2{
				margin-top: 0;
				border-top: none;
			}
			
			.catchcon{
				padding: 0 2rem;
			}
			.catchcon .blank{
				margin-top: 2rem;
				font-size: 1.6rem;
				color: #999999;
				text-align: center;
			}
			.catchcon .dd{
				display: flex;
				padding: 1rem 0;
				border-bottom: 1px solid #D4D4D4;
			}
			.catchcon .info{
				flex: 1;
			}
			.catchcon .title{
				font-size: 1.8rem;
			}
			.catchcon .more{
				font-size: 1.4rem;
				color: #999999;
			}
			.catchcon .oper{
				display: flex;
				align-items: center;
			}
			.catchcon .oper i{
				display: block;
				margin: -1rem 0;
				padding: 1rem;
				font-size: 2rem;
				cursor: pointer;
			}
			.catchcon .oper i.w{
				color: #EE5555;
			}
			.catchcon .sort{
				display: flex;
				align-items: center;
				margin-left: -1rem;
			}
			.catchcon .sort i{
				width: 2rem;
				font-size: 2.4rem;
				cursor: pointer;
			}
			.catchcon .sort i.l{
				padding-right: 0.2rem;
				text-align: right;
			}
			.catchcon .sort i.r{
				padding-left: 0.2rem;
				text-align: left;
			}
			.catchcon .sort i:hover{
				color: #3399FF;
				background-color: rgba(0, 0, 0, 0.1);
			}
			
			.initbox{
				display: flex;
				flex-direction: column;
				align-items: center;
				margin-top: 4rem;
				font-size: 2.4rem;
			}
			.initbox button{
				margin-top: 2rem;
				padding: 1rem 2rem;
				font-size: 1.6rem;
			}
			
			.catchbox{
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: rgba(0, 0, 0, 0.4);
				opacity: 0;
				pointer-events: none;
			}
			.catchbox.show{
				opacity: 1;
				pointer-events: all;
			}
			.catchbox .close{
				display: block;
				position: absolute;
				top: 1rem;
				right: 1rem;
				padding: 1rem;
				width: 4rem;
				height: 4rem;
				line-height: 4rem;
				text-align: center;
				font-size: 4rem;
				color: #FFFFFF;
				cursor: pointer;
			}
			.catchbox .con{
				width: 50%;
				height: 100%;
				margin-left: -50%;
				background-color: #FFFFFF;
				overflow: auto;
			}
			.catchbox .con.show{
				margin-left: 0;
			}
			.catchbox .add{
				margin: 1rem;
				padding: 1rem;
				font-size: 1.6rem;
				color: #3399FF;
				border: 0.2rem dashed #3399FF;
				text-align: center;
				border-radius: 1rem;
				cursor: pointer;
			}
			.catchbox .dd{
				display: flex;
				padding: 1rem;
				border-top: 1px solid #D4D4D4;
				font-size: 1.6rem;
				word-break: break-all;
			}
			.catchbox .dd i{
				padding: 0 1rem;
				cursor: pointer;
			}
			.catchbox .dd i.w{
				color: #EE5555;
			}
			.catchbox .dd i.i{
				color: #3399FF;
			}
			.catchbox .dd span{
				flex: 1;
			}
			.catchbox .dd.active{
				color: #FFFFFF;
				background-color: #3399FF;
			}
			.catchbox .dd.active i{
				color: #FFFFFF;
			}
			.catchbox .end{
				margin: 1rem 0;
				font-size: 1.4rem;
				color: #999999;
				text-align: center;
			}
			
			.areabox{
				display: flex;
				align-items: center;
				justify-content: center;
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: rgba(0, 0, 0, 0.4);
			}
			.areabox .close{
				display: block;
				position: absolute;
				top: 1rem;
				right: 1rem;
				padding: 1rem;
				width: 4rem;
				height: 4rem;
				line-height: 4rem;
				text-align: center;
				font-size: 4rem;
				color: #FFFFFF;
				cursor: pointer;
			}
			.areabox .con{
				width: 80%;
				max-width: 50rem;
				height: 80%;
				max-height: 40rem;
				background-color: #FFFFFF;
				overflow: auto;
				border-radius: 1rem;
				overflow: auto;
			}
			.areabox .oper{
				display: flex;
				justify-content: space-around;
			}
			.areabox .oper .btn{
				width: 12rem;
				height: 4rem;
			}
			
			.floatbtn{
				position: fixed;
				right: 2rem;
				bottom: 2rem;
			}
			.floatbtn.dis{
				right: 10rem;
			}
			.floatbtn .lv1{
				display: flex;
				align-items: center;
				justify-content: center;
				position: relative;
				width: 6rem;
				height: 6rem;
				font-size: 1.2rem;
				color: #FFFFFF;
				background-color: #3399FF;
				border-radius: 3rem;
				box-shadow: 0 0.3rem 0.3rem #D4D4D4;
				cursor: pointer;
			}
			.floatbtn .lv2{
				display: flex;
				align-items: center;
				justify-content: center;
				position: relative;
				width: 4rem;
				height: 4rem;
				margin: 0 auto;
				margin-bottom: -4rem;
				font-size: 2rem;
				background-color: #FFFFFF;
				border-radius: 3rem;
				box-shadow: 0 0.3rem 0.3rem #D4D4D4;
			}
			.floatbtn .lv2 span{
				position: absolute;
				left: -1rem;
				right: -1rem;
				bottom: -3rem;
				width: 6rem;
				padding: 0.4rem 0rem;
				font-size: 1.2rem;
				white-space: nowrap;
				text-align: center;
				background-color: rgba(255, 255, 255, 0.8);
				opacity: 0;
				border-radius: 2rem;
				pointer-events: none;
			}
			.floatbtn.show .lv2{
				margin-bottom: 4rem;
			}
			.floatbtn.show .lv2 span{
				opacity: 1;
			}
			
			.domtoimg{
				display: inline-block;
				margin: 0;
				padding-bottom: 1rem;
			}
			
			.chartcon{
				width: 100%;
				height: 80rem;
			}
			.belowcon{
				margin-top: 1rem;
			}
		</style>
	</head>
	<body>
		<app></app>
		<script>
			new Vue({
				el:'app',
				data:{
					title:'',
					tab:'table',
					output:[],
					flag:'25',
					finish:false,
					sort:'dsd',
					copytext:'',
					iscopy:false,
					dis:{
						show:false,
						output:[],
						flag:'25',
						finish:false,
					},
					catchdata:{
						show:false,
						type:null,
						list:[],
						item:null,
					},
					areabox:{
						show:false,
						type:null,
						text:'',
						hold:'',
					},
					pageobs:null,
					poa2:{
						show:false,
						th2:{
							transform: 'translateY(0rem)',
						},
					},
					inpshow:false,
					disshow:false,
					chart:null,
					ischart:false,
					isbelow:false,
					belowdata:[],
					updatetext:[
						{
							title:'V0.1.25',
							con:[
								'• 优化：修改次数的贡献计算方式。',
							],
						},
						{
							title:'V0.1.24',
							con:[
								'• 优化：均伤图表和贡献排名新开标签。',
								'• 优化：贡献排名增加导出图片功能。',
							],
						},
						{
							title:'V0.1.23',
							con:[
								'• 特性：增加贡献排名功能，综合历史所有合格情况。',
								'• 优化：从记录取列表显示士气。',
							],
						},
						{
							title:'V0.1.22',
							con:[
								'• 特性：增加折线图统计功能。',
							],
						},
						{
							title:'V0.1.21',
							con:[
								'• 优化：修正对比数据计算参数。',
								'• 修复：修复表格中的旗子不跟随输入框变化问题。',
							],
						},
						{
							title:'V0.1.20',
							con:[
								'• 特性：增加调整记录顺序功能。',
								'• 特性：增加表格生成图片功能。',
								'• 修复：修复表格无法复制问题。',
							],
						},
						{
							title:'V0.1.19',
							con:[
								'• 特性：增加日志标签页。',
							],
						},
						{
							title:'V0.1.18',
							con:[
								'• 特性：增加标签页切换功能，增加说明标签页。',
								'• 特性：增加均伤数据对比。',
								'• 特性：从记录取的数据作为当前记录的选中项。',
								'• 特性：记录可以自定义标题。',
								'• 优化：修改文本描述，缓存改为记录。',
								'• 优化：统计和对比数据按钮移到界面右下角。',
								'• 优化：把记录管理单独成标签，记录导入导出按钮移到记录标签里。',
								'• 修复：修复表格滚动时表头消失问题。',
							],
						},
						{
							title:'V0.0.17',
							con:[
								'• 修复：修复总伤为0时均伤计算错误问题。',
							],
						},
					],
				},
				computed:{
					omit(){
						return function(v){
							return (v/1000000).toFixed(2);
						};
					},
					maxqty(){
						let num=0;
						for(let item of this.output){
							num=Math.max(num,item.qty);
						};
						return num;
					},
					admg(){
						let num=0;
						for(let item of this.output){
							num+=item.dmg;
						};
						return num/this.output.length;
					},
					aavg(){
						let num=0;
						for(let item of this.output){
							num+=item.avg;
						};
						return num/this.output.length;
					},
					qcolor(){
						return function(v){
							let color='';
							if(v==this.maxqty){
								color='#3399FF';
							};
							if(v<this.maxqty-6){
								color='#EE5555';
							};
							return color;
						};
					},
					dcolor(){
						return function(v){
							let color='';
							if(v<=10){
								color='#3399FF';
							};
							if(v==this.output.length){
								color='#EE5555';
							};
							return color;
						};
					},
					ncolor(){
						return function(v,n){
							let num=0;
							let color='';
							if(v=='#3399FF'){
								num++;
							};
							if(v=='#EE5555'){
								num--;
							};
							if(n=='#3399FF'){
								num++;
							};
							if(n=='#EE5555'){
								num--;
							};
							if(num>0){
								color='#3399FF';
							};
							if(num<0){
								color='#EE5555';
							};
							return color;
						};
					},
				},
				template:`
					<div class="anisn">
						<div class="header">
							<span class="tab anitran1" v-bind:class="{active:tab=='table'}" v-on:click="tab='table'"><i class="b l anitran1"><i class="c"></i></i>表格<i class="b r anitran1"><i class="c"></i></i></span>
							<span class="tab anitran1" v-bind:class="{active:tab=='nail'}" v-on:click="tab='nail'"><i class="b l anitran1"><i class="c"></i></i>总览<i class="b r anitran1"><i class="c"></i></i></span>
							<span class="tab anitran1" v-bind:class="{active:tab=='record'}" v-on:click="tab='record'"><i class="b l anitran1"><i class="c"></i></i>记录<i class="b r anitran1"><i class="c"></i></i></span>
							<span class="tab anitran1" v-bind:class="{active:tab=='intro'}" v-on:click="tab='intro'"><i class="b l anitran1"><i class="c"></i></i>说明<i class="b r anitran1"><i class="c"></i></i></span>
							<span class="tab anitran1" v-bind:class="{active:tab=='update'}" v-on:click="tab='update'"><i class="b l anitran1"><i class="c"></i></i>日志<i class="b r anitran1"><i class="c"></i></i></span>
							<span class="blank"></span>
						</div>
						<div v-if="tab=='table'">
							<div class="control" v-if="!!catchdata.item">
								<span>记录时间</span>
								<span>{{catchdata.item.time}}</span>
							</div>
							<div class="control" v-if="finish">
								<span>标题</span>
								<input class="text" v-if="!!catchdata.item" v-model="catchdata.item.title" v-on:change="savedata" placeholder="起个名字吧">
								<input class="text" v-else v-model="title" placeholder="起个名字吧">
							</div>
							<div class="control" v-if="finish">
								<span>士气</span>
								<input class="text" v-if="!!catchdata.item" v-model="catchdata.item.flag" v-on:change="changeflag" v-on:change="savedata" placeholder="25~45之间">
								<input class="text" v-else v-model="flag" placeholder="25~45之间">
							</div>
							<div class="control" v-if="finish">
								<span>操作</span>
								<button class="btn imp" v-on:click="copy">复制</button>
								<button class="btn imp" v-on:click="catch_add">保存</button>
								<button class="btn imp" v-on:click="domtoimage">图片</button>
							</div>
							<div ref="tabletd"></div>
							<div class="initbox" v-if="false">
								<div>统计数据</div>
								<button class="btn imp" v-on:click="area_show('inp','输入从游戏中导出的数据：部落->资讯->前次突袭->复制')">从游戏取</button>
								<button class="btn imp" v-on:click="area_show('tinp','输入从表格中复制的数据，来源是之前点复制按钮出来的数据')">从表格取</button>
								<button class="btn imp" v-on:click="catch_show('inp')">从记录取</button>
							</div>
							<div class="tablebox">
								<div class="table poa">
									<table>
										<tr class="th1">
											<th class="anitran1" v-bind:style="poa2.th2">名字</th>
										</tr>
										<tr v-for="(item,index) in output">
											<td><font v-bind:color="ncolor(qcolor(item.qty),dcolor(item.dmgrank))">{{item.name}}</font></td>
										</tr>
									</table>
								</div>
								<div class="table por">
									<table>
										<tr class="anitran1" v-bind:style="poa2.th2">
											<th>id</th>
											<th class="cp" v-bind:class="{im:sort=='qsu'||sort=='qsd'}" v-on:click="qschange">次数 <span v-if="sort=='qsu'">▲</span><span v-else>▼</span></th>
											<th>总伤(M)</th>
											<th class="cp" v-bind:class="{im:sort=='dsu'||sort=='dsd'}" v-on:click="dschange">排名 <span v-if="sort=='dsu'">▼</span><span v-else>▲</span></th>
											<th>均伤(M)</th>
											<th class="cp" v-bind:class="{im:sort=='asu'||sort=='asd'}" v-on:click="aschange">排名 <span v-if="sort=='asu'">▼</span><span v-else>▲</span></th>
											<th>汇总</th>
										</tr>
										<tr ref="poa2top" v-for="(item,index) in output">
											<td>{{item.id}}</td>
											<td><font v-bind:color="qcolor(item.qty)">{{item.qty}}</font></td>
											<td><font v-bind:color="dcolor(item.dmgrank)">{{omit(item.dmg)}}</font></td>
											<td>
												{{item.dmgrank}}
												<span class="cu" v-if="!!item.pdmgrank&&item.pdmgrank>item.dmgrank"> ↑{{item.pdmgrank-item.dmgrank}}</span>
												<span class="cd" v-if="!!item.pdmgrank&&item.pdmgrank<item.dmgrank"> ↓{{item.dmgrank-item.pdmgrank}}</span>
											</td>
											<td>
												{{omit(item.avg)}}
												<span class="cu" v-if="!!item.pavg&&(item.pavg/(dis.flag/100+1.65)*(flag/100+1.65))<item.avg"> ↑{{omit(item.avg-(item.pavg/(dis.flag/100+1.65)*(flag/100+1.65)))}}</span>
												<span class="cd" v-if="!!item.pavg&&(item.pavg/(dis.flag/100+1.65)*(flag/100+1.65))>item.avg"> ↓{{omit((item.pavg/(dis.flag/100+1.65)*(flag/100+1.65))-item.avg)}}</span>
											</td>
											<td>
												{{item.avgrank}}
												<span class="cu" v-if="!!item.pavgrank&&item.pavgrank>item.avgrank"> ↑{{item.pavgrank-item.avgrank}}</span>
												<span class="cd" v-if="!!item.pavgrank&&item.pavgrank<item.avgrank"> ↓{{item.avgrank-item.pavgrank}}</span>
											</td>
											<td>
												<span v-if="index==0">人数</span>
												<span v-if="index==1">{{output.length}}</span>
												<span v-if="index==2">次数</span>
												<span v-if="index==3">{{maxqty}}</span>
												<span v-if="index==4">均总伤(M)</span>
												<span v-if="index==5">{{omit(admg)}}</span>
												<span v-if="index==6">均均伤(M)</span>
												<span v-if="index==7">{{omit(aavg)}}</span>
												<span v-if="index==8">满伤比</span>
												<span v-if="index==9">{{(omit(admg)/maxqty/omit(aavg)).toFixed(2)}}</span>
												<span v-if="index==10">旗子</span>
												<span v-if="index==11">{{flag}}</span>
											</td>
										</tr>
									</table>
									<div class="domtoimg anisa" ref="table" v-show="iscopy">
										<table class="anisa">
											<tr>
												<th>名字</th>
												<th>id</th>
												<th>次数</th>
												<th>总伤(M)</th>
												<th>排名</th>
												<th>均伤(M)</th>
												<th>排名</th>
												<th>汇总</th>
											</tr>
											<tr v-for="(item,index) in output">
												<td><font v-bind:color="ncolor(qcolor(item.qty),dcolor(item.dmgrank))">{{item.name}}</font></td>
												<td>{{item.id}}</td>
												<td><font v-bind:color="qcolor(item.qty)">{{item.qty}}</font></td>
												<td><font v-bind:color="dcolor(item.dmgrank)">{{omit(item.dmg)}}</font></td>
												<td>{{item.dmgrank}}</td>
												<td>{{omit(item.avg)}}</td>
												<td>{{item.avgrank}}</td>
												<td>
													<span v-if="index==0">人数</span>
													<span v-if="index==1">{{output.length}}</span>
													<span v-if="index==2">次数</span>
													<span v-if="index==3">{{maxqty}}</span>
													<span v-if="index==4">均总伤(M)</span>
													<span v-if="index==5">{{omit(admg)}}</span>
													<span v-if="index==6">均均伤(M)</span>
													<span v-if="index==7">{{omit(aavg)}}</span>
													<span v-if="index==8">满伤比</span>
													<span v-if="index==9">{{(omit(admg)/maxqty/omit(aavg)).toFixed(2)}}</span>
													<span v-if="index==10">旗子</span>
													<span v-if="index==11">{{flag}}</span>
												</td>
											</tr>
										</table>
									</div>
								</div>
								<div class="blank" v-if="output.length==0">无数据</div>
								<div class="logo">tt2raid {{updatetext[0].title}}</div>
							</div>
						</div>
						<div v-if="tab=='nail'">
							<div class="control">
								<button class="btn" v-on:click="chartshow">均伤图表</button>
								<button class="btn" v-on:click="belowshow">贡献排名</button>
								<button class="btn" v-if="isbelow" v-on:click="belowtoimg">图片</button>
							</div>
							<div class="chartcon" ref="chart" v-if="ischart"></div>
							<div class="belowcon" v-if="isbelow">
								<div class="table domtoimg anisa" ref="below">
									<table class="anisa">
										<tr>
											<th>排名</th>
											<th>名字</th>
											<th>id</th>
											<th>总均伤(M)</th>
											<th>总贡献</th>
										</tr>
										<tr v-for="(item,index) in belowdata">
											<td>{{index+1}}</td>
											<td>{{item.name}}</td>
											<td>{{item.id}}</td>
											<td>{{omit(item.avg)}}</td>
											<td>{{item.num}}</td>
										</tr>
									<table>
								</div>
							</div>
						</div>
						<div v-if="tab=='record'">
							<div class="control">
								<button class="btn" v-on:click="catch_in">导入记录</button>
								<button class="btn" v-on:click="catch_out">导出记录</button>
							</div>
							<div class="catchcon">
								<div class="dd" v-for="(item,index) of catchdata.list">
									<div class="sort">
										<i class="l" v-on:click="catchsp(index)">↿</i>
										<i class="r" v-on:click="catchsn(index)">⇂</i>
									</div>
									<div class="info">
										<div class="title">{{item.title}}</div>
										<div class="more">{{item.time}}</div>
										<div class="more">+{{item.flag}}%士气</div>
									</div>
									<div class="oper">
										<i class="w" v-on:click="catch_del(index,item)">✕</i>
									</div>
								</div>
								<div class="blank" v-if="catchdata.list.length==0">无记录</div>
							</div>
						</div>
						<div v-if="tab=='intro'">
							<div class="introcon">
								<div>
									<div class="p">• 本功能可以从游戏中导入突袭数据，处理后已表格形式展示统计结果。</div>
									<div class="p">• 有3种导入方式：导入游戏中的突袭数据、导入从本功能复制出来的数据、导入保存在本功能记录中的数据。</div>
									<div class="p">• 展示统计结果后可以再和另一条数据进行对比，对比项有总伤排名、均伤、均伤排名。</div>
									<div class="p">• 对比有2种导入方式：导入从本功能复制出来的数据、导入保存在本功能记录中的数据。</div>
									<div class="p">• 展示统计结果后可以把数据复制出来，粘贴到excel中备份，也可以直接保存到记录中，记录中的数据可以随时导入导出。</div>
									<div class="p">• 展示统计结果后可以把数据保存成图片。</div>
								</div>
							</div>
						</div>
						<div v-if="tab=='update'">
							<div class="introcon">
								<div v-for="item in updatetext">
									<div class="h2">{{item.title}}</div>
									<div class="p" v-for="con in item.con">{{con}}</div>
								</div>
							</div>
						</div>
						<div class="floatbtn" v-if="tab=='table'" v-bind:class="{show:inpshow}">
							<div class="lv2 anitran1" v-on:click="area_show('inp','输入从游戏中导出的数据：部落->资讯->前次突袭->复制')">-><span>从游戏取</span></div>
							<div class="lv2 anitran1" v-on:click="area_show('tinp','输入从表格中复制的数据，来源是之前点复制按钮出来的数据')">-><span>从表格取</span></div>
							<div class="lv2 anitran1" v-on:click="catch_show('inp')">-><span>从记录取</span></div>
							<div class="lv1" v-on:click="inpshow=!inpshow">统计<br>数据</div>
						</div>
						<div class="floatbtn dis" v-if="tab=='table'&&finish" v-bind:class="{show:disshow}">
							<div class="lv2 anitran1" v-on:click="area_show('tdis','输入对比数据，来源是之前点复制按钮出来的数据')">-><span>从表格取</span></div>
							<div class="lv2 anitran1" v-on:click="catch_show('dis')">-><span>从记录取</span></div>
							<div class="lv1" v-on:click="disshow=!disshow">对比<br>数据</div>
						</div>
						<div class="catchbox anitran1" v-bind:class="{show:catchdata.show}">
							<i class="close" v-on:click="catchdata.show=false">✕</i>
							<div class="con anitran1" v-bind:class="{show:catchdata.show}">
								<div class="end" v-if="catchdata.list.length>0">到顶了</div>
								<div class="dd" v-for="(item,index) of catchdata.list" v-bind:class="{active:!!catchdata.item&&catchdata.item.time==item.time}" v-on:click="catch_get(index,item)">
									<span>{{item.title}} (+{{item.flag}}%)</span>
								</div>
								<div class="end" v-if="catchdata.list.length==0">无记录</div>
								<div class="end" v-if="catchdata.list.length>0">到底了</div>
							</div>
						</div>
						<div class="areabox" v-if="areabox.show">
							<i class="close" v-on:click="areabox.show=false">✕</i>
							<div class="con">
								<div class="inputbox">
									<textarea class="input" ref="input" v-model="areabox.text" v-bind:placeholder="areabox.hold"></textarea>
								</div>
								<div class="oper">
									<button class="btn imp" v-on:click="areabox_sure">确定</button>
								</div>
							</div>
						</div>
					</div>
				`,
				watch:{
					tab(e){
						this.chart.dispose();
						this.ischart=false;
						if(e=='table'){
							setTimeout(()=>{
								this.pageobs.observe(this.$refs.tabletd);
							},0);
						};
					},
				},
				methods: {
					start(input) {
						this.title='';
						this.catchdata.item=null;
						this.flag='25';
						this.sort='dsd';
						this.output=[];
						let input_td=input.split('\n');
						let input_th=input_td.shift();
						let totaldmg_json={};
						for(let item of input_td){
							let arr=item.split(',');
							if(arr.length>1){
								if(!!!totaldmg_json[arr[1]]){
									totaldmg_json[arr[1]]={
										name:arr[0],
										qty:parseInt(arr[2]),
										dmg:0,
									};
								};
								totaldmg_json[arr[1]].dmg+=parseFloat(arr[5]);
							};
						};
						for(let index in totaldmg_json){
							this.output.push({
								id:index,
								name:totaldmg_json[index].name,
								qty:totaldmg_json[index].qty,
								dmg:totaldmg_json[index].dmg,
								avg:totaldmg_json[index].qty>0?totaldmg_json[index].dmg/totaldmg_json[index].qty:0,
							});
						};
						this.output.sort(function (a,b){
							return b.avg-a.avg;
						});
						for(let index in this.output){
							this.output[index].avgrank=parseInt(index)+1;
						};
						this.output.sort(function (a,b){
							return b.dmg-a.dmg;
						});
						for(let index in this.output){
							this.output[index].dmgrank=parseInt(index)+1;
						};
						if(this.output.length>0){
							this.finish=true;
							setTimeout(()=>{
								this.pageobs.observe(this.$refs.tabletd);
							},0);
						}else{
							alert('数据格式错误，无法处理');
						};
					},
					qschange(){
						if(this.sort=='qsd'){
							this.sort='qsu';
							this.output.sort(function (a,b){
								return a.qty-b.qty;
							});
						}else{
							this.sort='qsd';
							this.output.sort(function (a,b){
								return b.qty-a.qty;
							});
						};
					},
					dschange(){
						if(this.sort=='dsd'){
							this.sort='dsu';
							this.output.sort(function (a,b){
								return a.dmg-b.dmg;
							});
						}else{
							this.sort='dsd';
							this.output.sort(function (a,b){
								return b.dmg-a.dmg;
							});
						};
					},
					aschange(){
						if(this.sort=='asd'){
							this.sort='asu';
							this.output.sort(function (a,b){
								return a.avg-b.avg;
							});
						}else{
							this.sort='asd';
							this.output.sort(function (a,b){
								return b.avg-a.avg;
							});
						};
					},
					copy(){
						this.iscopy=true;
						setTimeout(()=>{
							window.getSelection().removeAllRanges();
							let range = document.createRange();
							range.selectNode(this.$refs.table);
							window.getSelection().addRange(range);
							document.execCommand("copy");
							window.getSelection().removeAllRanges();
							this.iscopy=false;
							alert('复制了');
						},0);
					},
					copy2(){
						// 获取表格元素
						let table = this.$refs.table;
						// 获取表格行数和列数
						let rows = table.rows.length;
						let cols = table.rows[0].cells.length;
						// 拼接表格数据
						let data = "";
						for (let i = 0; i < rows; i++) {
							for (let j = 0; j < cols; j++) {
								// 获取单元格内容
								let cell = table.rows[i].cells[j].innerText;
								// 添加制表符和换行符
								data += cell + (j < cols - 1 ? "\t" : "\n");
							}
						}
						// 调用navigator.clipboard.writeText()方法，将拼接好的数据写入到剪贴板中
						navigator.clipboard.writeText(data).then(
							function () {
								// 复制成功时执行的回调函数
								alert("复制成功");
							},
							function (err) {
								// 复制失败时执行的回调函数
								alert("复制失败: ", err);
							}
						);
					},
					changeflag(){
						this.flag=this.catchdata.item.flag;
					},
					savedata(){
						localStorage.setItem('catchdata',JSON.stringify(this.catchdata.list));
					},
					inp_start(input){
						this.title='';
						this.catchdata.item=null;
						this.flag='25';
						this.sort='dsd';
						this.output=[];
						let input_td=input.split('\n');
						let input_th=input_td.shift();
						for(let i in input_td){
							let arr=input_td[i].split('\t');
							if(arr.length>1){
								if(i==11){
									this.flag=arr[7];
								};
								this.output.push({
									id:arr[1],
									name:arr[0],
									qty:parseFloat(arr[2]),
									dmg:parseFloat(arr[3])*1000000,
									dmgrank:parseFloat(arr[4]),
									avg:parseFloat(arr[5])*1000000,
									avgrank:parseFloat(arr[6]),
								});
							};
						};
						this.finish=true;
						setTimeout(()=>{
							this.pageobs.observe(this.$refs.tabletd);
						},0);
					},
					dis_start(input){
						let input_td=input.split('\n');
						let input_th=input_td.shift();
						let disoutput=this.output;
						bool=true;
						for(let i in input_td){
							let arr=input_td[i].split('\t');
							if(arr.length>1){
								if(i==11){
									this.dis.flag=arr[7];
								};
								let player=disoutput.find((v)=>{return v.id==arr[1]});
								if(!!player){
									bool=false;
									player.pdmg=parseFloat(arr[3])*1000000;
									player.pdmgrank=parseFloat(arr[4]);
									player.pavg=parseFloat(arr[5])*1000000;
									player.pavgrank=parseFloat(arr[6]);
								};
							};
						};
						this.output=[];
						this.output=disoutput;
						if(bool){
							alert('数据格式错误，无法处理');
						};
					},
					catch_show(type){
						this.catchdata.type=type;
						this.catchdata.show=true;
					},
					catch_add(){
						let output=[];
						for(let item of this.output){
							output.push({
								id:item.id,
								name:item.name,
								qty:item.qty,
								dmg:item.dmg,
								dmgrank:item.dmgrank,
								avg:item.avg,
								avgrank:item.avgrank,
							});
						};
						this.catchdata.list.unshift({
							title:this.title||JSON.stringify(new Date()).replace(/\"/g, "").replace(/T/g, " ").replace(/Z/g, ""),
							time:JSON.stringify(new Date()).replace(/\"/g, "").replace(/T/g, " ").replace(/Z/g, ""),
							text:JSON.stringify(output),
							flag:this.flag,
						});
						this.savedata();
						alert('保存到记录了');
					},
					catch_del(v,n){
						let bool=confirm('确定要删除'+n.time+'这条记录么？');
						if(bool){
							this.catchdata.list.splice(v, 1);
						};
						this.savedata();
					},
					catch_get(v,n){
						switch(this.catchdata.type){
							case 'inp' :
							this.catchdata.item=n;
							this.title=n.title;
							this.output=JSON.parse(n.text);
							this.flag=n.flag;
							this.finish=true;
							this.inpshow=false
							this.disshow=false
							this.catchdata.show=false;
							setTimeout(()=>{
								this.pageobs.observe(this.$refs.tabletd);
							},0);
							break;
							case 'dis' :
							let input=JSON.parse(n.text);
							for(let item of input){
								let player=this.output.find((v)=>{return v.id==item.id});
								if(!!player){
									player.pdmg=item.dmg;
									player.pdmgrank=item.dmgrank;
									player.pavg=item.avg;
									player.pavgrank=item.avgrank;
								};
							};
							this.dis.flag=n.flag;
							this.inpshow=false
							this.disshow=false
							this.catchdata.show=false;
							break;
							default:
							alert('异常操作');
						};
					},
					area_show(type,hold){
						this.areabox.type=type;
						this.areabox.hold=hold;
						this.areabox.text='';
						this.areabox.show=true;
						setTimeout(()=>{
							this.$refs.input.focus();
						},0);
					},
					areabox_sure(){
						if(!!!this.areabox.text){
							return false;
						};
						switch(this.areabox.type){
							case 'inp' :
							this.start(this.areabox.text);
							this.inpshow=false
							this.disshow=false
							this.areabox.show=false;
							break;
							case 'tinp' :
							this.inp_start(this.areabox.text);
							this.inpshow=false
							this.disshow=false
							this.areabox.show=false;
							break;
							case 'tdis' :
							this.dis_start(this.areabox.text);
							this.inpshow=false
							this.disshow=false
							this.areabox.show=false;
							break;
							default:
							alert('异常操作');
						};
					},
					catchsp(index){
						if(index>0){
							let i = this.catchdata.list.splice(index, 1);
							this.catchdata.list.splice(index-1, 0, i[0]);
							this.savedata();
						};
					},
					catchsn(index){
						if(index<this.catchdata.list.length-1){
							let i = this.catchdata.list.splice(index, 1);
							this.catchdata.list.splice(index+1, 0, i[0]);
							this.savedata();
						};
					},
					catch_in(){
						let file=document.createElement("input");
						file.type="file";
						file.accept=".txt";
						file.onchange=()=>{
							let reader = new FileReader();
							reader.readAsText(file.files[0]);
							reader.onload = (e) =>{
								let list;
								try{
									list=JSON.parse(decodeURIComponent(atob(e.target.result)));
								}catch(e){};
								if(!!!list){
									alert('数据异常');
									return false;
								};
								this.catchdata.list=list;
								this.savedata();
								alert('导入成功');
							}
						};
						file.click();
					},
					catch_out(){
						const stringData = btoa(encodeURIComponent(JSON.stringify(this.catchdata.list)));
						const blob = new Blob([stringData], {
							type: "text/plain;charset=utf-8"
						});
						const objectURL = URL.createObjectURL(blob);
						const aTag = document.createElement('a');
						aTag.href = objectURL;
						aTag.download = 'tt2raid_catch_'+JSON.stringify(new Date()).replace(/\"/g, "").replace(/T/g, "_").replace(/:/g, "").replace(/\./g, "").replace(/Z/g, "").replace(/ /g, "")+'.txt';
						aTag.click();
						URL.revokeObjectURL(objectURL);
					},
					domtoimage(){
						this.iscopy=true;
						domtoimage.toBlob(this.$refs.table).then((blob)=>{
							this.iscopy=false;
							const objectURL = URL.createObjectURL(blob);
							const aTag = document.createElement('a');
							aTag.href = objectURL;
							aTag.download = 'tt2raid_img_'+JSON.stringify(new Date()).replace(/\"/g, "").replace(/T/g, "_").replace(/:/g, "").replace(/\./g, "").replace(/Z/g, "").replace(/ /g, "")+'.png';
							aTag.click();
							URL.revokeObjectURL(objectURL);
						});
					},
					chartshow(){
						if(this.ischart){
							return false;
						};
						this.ischart=true;
						setTimeout(()=>{
							this.chart=echarts.init(this.$refs.chart, null, { renderer: 'svg' });
							let option = {
								grid:{
									top:60,
									bottom:20,
									left:20,
									right:20,
								},
								legend: {
									top: 10,
									itemWidth: 10,
									itemHeight: 10,
									selector: true,
									selectorPosition:'stert',
									type: 'scroll',
								},
								dataZoom:[
									{},
									{
										type:'slider',
										// handlePosition:'inside',
										handleStyle: { borderWidth: 4 },
										brushSelect:false,
										handleSize:'200%',
									}
								],
								xAxis: {
									type: 'category',
									data: [],
									boundaryGap: false,
								},
								yAxis: {
									type: 'value'
								},
								series: [{
									name:'平均值',
									type:'line',
									data:[],
									lineStyle:{
										type:'dashed',
									},
								}]
							};
							let times=[];
							for(let item of this.catchdata.list){
								times.unshift(item);
							};
							let firstp={};
							let zoomp=0;
							for(let list in times){
								option.xAxis.data.push(times[list].title);
								let avgtotal=0;
								for(let user of JSON.parse(times[list].text)){
									let s=option.series.find((v)=>{
										return v.id==user.id;
									});
									if(!!!s){
										let data=[];
										data[list]=parseFloat((user.avg/1000000).toFixed(2));
										option.series.push({
											id:user.id,
											name:user.name,
											data: data,
											type:'line',
											label:{
												show:true,
												position:'right',
												// formatter:'{a}',
												formatter: function (params) {
													let z;
													if(parseInt(firstp[user.id])<zoomp){
														if(parseInt(firstp[user.id])>0){
															z=zoomp;
														}else{
															z=parseInt(firstp[user.id])+zoomp;
														};
													}else{
														z=parseInt(firstp[user.id]);
													};
													if(params.dataIndex==z){
														return params.seriesName; 
													}else{
														return '';
													};
												},
											},
										});
										firstp[user.id]=list;
									}else{
										s.data[list]=parseFloat((user.avg/1000000).toFixed(2));
									};
									avgtotal+=parseFloat((user.avg/1000000).toFixed(2));
								};
								avgtotal=avgtotal/JSON.parse(times[list].text).length;
								option.series[0].data.push(avgtotal);
							};
							console.log(firstp);
							this.chart.setOption(option);
							this.chart.on('dataZoom',(params)=>{
								zoomp=this.chart.getOption().dataZoom[1].startValue;
							});
						},0);
					},
					list_maxqty(data){
						let num=0;
						for(let item of data){
							num=Math.max(num,item.qty);
						};
						return num;
					},
					list_qcolor(data,v){
						let num=0;
						num=Math.floor((v-this.list_maxqty(data))/6)+1;
						// if(v==this.list_maxqty(data)){
						// 	num++;
						// };
						// if(v<this.list_maxqty(data)-6){
						// 	num--;
						// };
						return num;
					},
					list_dcolor(data,v){
						let num=0;
						if(v<=10){
							num++;
						};
						if(v==data.length){
							num--;
						};
						return num;
					},
					countChar(text) {
						var len = 0;
						for (var i = 0; i < text.length; i++) {
							if (text.charCodeAt(i) > 127) {
								len += 2;
							} else {
								len++;
							}
						}
						return len;
					},
					belowshow(){
						if(this.isbelow){
							this.isbelow=false;
							return false;
						};
						this.isbelow=true;
						let names={};
						let scores={};
						for(let user of JSON.parse(this.catchdata.list[0].text)){
							names[user.id]=this.countChar(user.name)<=16?user.name:user.name.substring(0,8)+'...';
						};
						for(let list of this.catchdata.list){
							let users=JSON.parse(list.text);
							for(let user of users){
								if(!!names[user.id]){
									if(!!!scores[user.id]){
										scores[user.id]={
											num:0,
											avg:0,
											count:0,
										};
									};
									scores[user.id].num+=this.list_qcolor(users,user.qty)+this.list_dcolor(users,user.dmgrank);
									scores[user.id].avg+=user.avg;
									scores[user.id].count++;
								};
							};
						};
						this.belowdata=[];
						for(let key in names){
							this.belowdata.push({
								id:key,
								name:names[key],
								num:scores[key].num,
								avg:scores[key].avg/scores[key].count,
							});
						};
						this.belowdata.sort(function (a,b){
							return b.num-a.num;
						});
					},
					belowtoimg(){
						domtoimage.toBlob(this.$refs.below).then((blob)=>{
							const objectURL = URL.createObjectURL(blob);
							const aTag = document.createElement('a');
							aTag.href = objectURL;
							aTag.download = 'tt2raid_img_'+JSON.stringify(new Date()).replace(/\"/g, "").replace(/T/g, "_").replace(/:/g, "").replace(/\./g, "").replace(/Z/g, "").replace(/ /g, "")+'.png';
							aTag.click();
							URL.revokeObjectURL(objectURL);
						});
					},
				},
				mounted(){
					let c;
					try{
						c=JSON.parse(localStorage.getItem('catchdata'));
					}catch(e){
						c=[];
					}
					if(!!!c){
						c=[];
					};
					this.catchdata.list=c;
					this.pageobs = new IntersectionObserver((entries, observer) => { 
						entries.forEach(entry => {
						console.log(entry.isIntersecting);
							if (entry.isIntersecting) { //true表示从不可视状态变为可视状态
								this.poa2.show=false;
							}else{
								this.poa2.show=true;
							};
						}) 
					}, {}); 
					window.document.onscroll=()=>{
						let thh=this.$refs.poa2top[0].clientHeight;
						let top=this.$refs.poa2top[0].getBoundingClientRect().top;
						if(this.poa2.show){
							this.poa2.th2.transform='translateY('+(thh-1-top)+'px)';
						}else{
							this.poa2.th2.transform='translateY(0)';
						};
					};
					window.addEventListener('resize',()=>{
						this.chart.resize();
					});
				},
			});
		</script>
	</body>
</html>
