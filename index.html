<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
		<title></title>
		<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.0/vue.min.js"></script>
		<style>
			*{
				font-family: "Microsoft Yahei";
			}
			i{
				display: inline-block;
				font-style: normal;
			}
			html{
				font-size: 10px;
			}
			html,body{
				margin: 0;
			}
			input,button,textarea{ border: none; background: transparent; vertical-align:middle; outline: none; overflow: visible;
				-webkit-user-select: auto;
			}
			table{border-collapse:collapse;border-spacing:0;}
			th{
				text-align: left;
			}
			th,td{
				padding: 0.5rem 1rem;
				border: 1px solid #D4D4D4;
				font-size: 1.6rem;
				white-space: nowrap;
			}
			button{
				border: 1px solid #D4D4D4;
				border-radius: 1rem;
				cursor: pointer;
			}
			button.imp{
				color: #FFFFFF;
				background-color: #3399FF;
			}
			.header{
				display: flex;
				justify-content: space-between;
				padding: 1rem 2rem;
				font-size: 1.6rem;
				background-color: #D4D4D4;
			}
			.inputbox{
				padding: 2rem;
			}
			.input{
				display: block;
				width: calc(100% - 2.4rem);
				height: 20rem;
				padding: 1rem;
				resize: none;
				border: 0.2rem solid #B2B2B2;
				border-radius: 1rem;
			}
			.input:focus{
				border-color: #3399FF;
			}
			td[color="1"]{
				background-color: #3399FF;
			}
			td[color="-1"]{
				background-color: #EE5555;
			}
			th.cp{
				cursor: pointer;
			}
			th.im{
				color: #3399FF;
			}
			.control{
				display: flex;
				align-items: center;
				padding: 0 1rem;
				margin-top: 1rem;
			}
			.control span{
				font-size: 1.6rem;
				margin: 0 1rem;
				white-space: nowrap;
			}
			.control .btn{
				width: 12rem;
				height: 4rem;
				margin: 0 1rem;
			}
			.control .text{
				box-sizing: border-box;
				width: 60px;
				height: 4rem;
				margin: 0 1rem;
				border: 0.2rem solid #B2B2B2;
				border-radius: 1rem;
				text-align: center;
			}
			.table{
				padding: 2rem;
				overflow: auto;
			}
			.table .cu{
				font-size: 1.2rem;
				color: #3399FF;
				font-weight: bold;
			}
			.table .cd{
				font-size: 1.2rem;
				color: #EE5555;
				font-weight: bold;
			}
			.table .hint{
				font-size: 1.6rem;
				margin-bottom: 1rem;
			}
			.catchbox{
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: rgba(0, 0, 0, 0.4);
			}
			.catchbox .close{
				display: block;
				position: absolute;
				top: 1rem;
				right: 1rem;
				padding: 1rem;
				width: 4rem;
				height: 4rem;
				line-height: 4rem;
				text-align: center;
				font-size: 4rem;
				color: #FFFFFF;
				cursor: pointer;
			}
			.catchbox .con{
				width: 50%;
				height: 100%;
				background-color: #FFFFFF;
				overflow: auto;
			}
			.catchbox .add{
				margin: 1rem;
				padding: 1rem;
				font-size: 1.6rem;
				color: #3399FF;
				border: 0.2rem dashed #3399FF;
				text-align: center;
				border-radius: 1rem;
				cursor: pointer;
			}
			.catchbox .dd{
				display: flex;
				padding: 1rem;
				padding-left: 0;
				border-bottom: 1px solid #D4D4D4;
				font-size: 1.6rem;
				word-break: break-all;
			}
			.catchbox .dd i{
				padding: 0 1rem;
				cursor: pointer;
			}
			.catchbox .dd i.w{
				color: #EE5555;
			}
			.catchbox .dd i.i{
				color: #3399FF;
			}
			.catchbox .dd span{
				flex: 1;
			}
			.areabox{
				display: flex;
				align-items: center;
				justify-content: center;
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: rgba(0, 0, 0, 0.4);
			}
			.areabox .close{
				display: block;
				position: absolute;
				top: 1rem;
				right: 1rem;
				padding: 1rem;
				width: 4rem;
				height: 4rem;
				line-height: 4rem;
				text-align: center;
				font-size: 4rem;
				color: #FFFFFF;
				cursor: pointer;
			}
			.areabox .con{
				width: 80%;
				max-width: 50rem;
				height: 80%;
				max-height: 40rem;
				background-color: #FFFFFF;
				overflow: auto;
				border-radius: 1rem;
				overflow: auto;
			}
			.areabox .oper{
				display: flex;
				justify-content: space-around;
			}
			.areabox .oper .btn{
				width: 12rem;
				height: 4rem;
			}
		</style>
	</head>
	<body>
		<app></app>
		<script>
			new Vue({
				el:'app',
				data:{
					input:'',
					output:[],
					flag:'25',
					finish:false,
					sort:'dsd',
					copytext:'',
					iscopy:false,
					dis:{
						show:false,
						input:'',
						output:[],
						flag:'25',
						finish:false,
					},
					catchdata:{
						show:false,
						model:null,
						type:null,
						list:[],
					},
					areabox:{
						show:false,
						type:null,
						text:'',
						hold:'',
					},
				},
				computed:{
					omit(){
						return function(v){
							return (v/1000000).toFixed(2);
						};
					},
					maxqty(){
						let num=0;
						for(let item of this.output){
							num=Math.max(num,item.qty);
						};
						return num;
					},
					admg(){
						let num=0;
						for(let item of this.output){
							num+=item.dmg;
						};
						return num/this.output.length;
					},
					aavg(){
						let num=0;
						for(let item of this.output){
							num+=item.avg;
						};
						return num/this.output.length;
					},
					qcolor(){
						return function(v){
							let color='';
							if(v==this.maxqty){
								color='#3399FF';
							};
							if(v<this.maxqty-6){
								color='#EE5555';
							};
							return color;
						};
					},
					dcolor(){
						return function(v){
							let color='';
							if(v<=10){
								color='#3399FF';
							};
							if(v==this.output.length){
								color='#EE5555';
							};
							return color;
						};
					},
					ncolor(){
						return function(v,n){
							let num=0;
							let color='';
							if(v=='#3399FF'){
								num++;
							};
							if(v=='#EE5555'){
								num--;
							};
							if(n=='#3399FF'){
								num++;
							};
							if(n=='#EE5555'){
								num--;
							};
							if(num>0){
								color='#3399FF';
							};
							if(num<0){
								color='#EE5555';
							};
							return color;
						};
					},
				},
				template:`
					<div>
						<div class="header">
							<span>tt2raid</span>
							<span>V0.0.14</span>
						</div>
						<div class="control">
							<span>统计数据</span>
							<button class="btn imp" v-on:click="area_show('inp','输入从游戏中导出的数据：部落->资讯->前次突袭->复制')">游戏导入</button>
							<button class="btn imp" v-on:click="area_show('tinp','输入从表格中复制的数据，来源是之前点复制按钮出来的数据')">表格导入</button>
							<button class="btn imp" v-on:click="catch_show('get','inp')">缓存导入</button>
						</div>
						<div class="control">
							<span>开突袭士气</span>
							<input class="text" v-model="flag">
						</div>
						<div class="control" v-if="finish">
							<span>对比数据</span>
							<button class="btn imp" v-on:click="area_show('tdis','输入对比数据，来源是之前点复制按钮出来的数据')">表格导入</button>
							<button class="btn imp" v-on:click="catch_show('get','dis')">缓存导入</button>
						</div>
						<div class="control">
							<span>其他</span>
							<button class="btn imp" v-if="finish" v-on:click="copy">复制</button>
							<button class="btn imp" v-on:click="catch_show('set')">缓存管理</button>
						</div>
						<div class="table">
							<div class="hint">* 请及时将需要保存的数据复制粘贴到excel中保存</div>
							<table>
								<tr>
									<th>名字</th>
									<th>id</th>
									<th>次数</th>
									<th>总伤(M)</th>
									<th class="cp" v-bind:class="{im:sort=='dsu'||sort=='dsd'}" v-on:click="dschange">排名 <span v-if="sort=='dsu'">▼</span><span v-else>▲</span></th>
									<th>均伤(M)</th>
									<th class="cp" v-bind:class="{im:sort=='asu'||sort=='asd'}" v-on:click="aschange">排名 <span v-if="sort=='asu'">▼</span><span v-else>▲</span></th>
									<th>汇总</th>
								</tr>
								<tr v-for="(item,index) in output">
									<td><font v-bind:color="ncolor(qcolor(item.qty),dcolor(item.dmgrank))">{{item.name}}</font></td>
									<td>{{item.id}}</font></td>
									<td><font v-bind:color="qcolor(item.qty)">{{item.qty}}</font></td>
									<td><font v-bind:color="dcolor(item.dmgrank)">{{omit(item.dmg)}}</font></td>
									<td>
										{{item.dmgrank}}
										<span class="cu" v-if="!!item.pdmgrank&&item.pdmgrank>item.dmgrank"> ↑{{item.pdmgrank-item.dmgrank}}</span>
										<span class="cd" v-if="!!item.pdmgrank&&item.pdmgrank<item.dmgrank"> ↓{{item.dmgrank-item.pdmgrank}}</span>
									</td>
									<td>{{omit(item.avg)}}</td>
									<td>
										{{item.avgrank}}
										<span class="cu" v-if="!!item.pavgrank&&item.pavgrank>item.avgrank"> ↑{{item.pavgrank-item.avgrank}}</span>
										<span class="cd" v-if="!!item.pavgrank&&item.pavgrank<item.avgrank"> ↓{{item.avgrank-item.pavgrank}}</span>
									</td>
									<td>
										<span v-if="index==0">人数</span>
										<span v-if="index==1">{{output.length}}</span>
										<span v-if="index==2">次数</span>
										<span v-if="index==3">{{maxqty}}</span>
										<span v-if="index==4">均总伤(M)</span>
										<span v-if="index==5">{{omit(admg)}}</span>
										<span v-if="index==6">均均伤(M)</span>
										<span v-if="index==7">{{omit(aavg)}}</span>
										<span v-if="index==8">满伤比</span>
										<span v-if="index==9">{{(omit(admg)/maxqty/omit(aavg)).toFixed(2)}}</span>
										<span v-if="index==10">旗子</span>
										<span v-if="index==11">{{flag}}</span>
									</td>
								</tr>
							</table>
							<table ref="table" v-show="iscopy">
								<tr>
									<th>名字</th>
									<th>id</th>
									<th>次数</th>
									<th>总伤(M)</th>
									<th>排名</th>
									<th>均伤(M)</th>
									<th>排名</th>
									<th>汇总</th>
								</tr>
								<tr v-for="(item,index) in output">
									<td><font v-bind:color="ncolor(qcolor(item.qty),dcolor(item.dmgrank))">{{item.name}}</font></td>
									<td>{{item.id}}</font></td>
									<td><font v-bind:color="qcolor(item.qty)">{{item.qty}}</font></td>
									<td><font v-bind:color="dcolor(item.dmgrank)">{{omit(item.dmg)}}</font></td>
									<td>{{item.dmgrank}}</td>
									<td>{{omit(item.avg)}}</td>
									<td>{{item.avgrank}}</td>
									<td>
										<span v-if="index==0">人数</span>
										<span v-if="index==1">{{output.length}}</span>
										<span v-if="index==2">次数</span>
										<span v-if="index==3">{{maxqty}}</span>
										<span v-if="index==4">均总伤(M)</span>
										<span v-if="index==5">{{omit(admg)}}</span>
										<span v-if="index==6">均均伤(M)</span>
										<span v-if="index==7">{{omit(aavg)}}</span>
										<span v-if="index==8">满伤比</span>
										<span v-if="index==9">{{(omit(admg)/maxqty/omit(aavg)).toFixed(2)}}</span>
										<span v-if="index==10">旗子</span>
										<span v-if="index==11">{{flag}}</span>
									</td>
								</tr>
							</table>
						</div>
						<div class="catchbox" v-if="catchdata.show">
							<i class="close" v-on:click="catchdata.show=false">✕</i>
							<div class="con">
								<div class="add" v-if="finish" v-on:click="catch_add">+ 保存当前数据</div>
								<div class="dd" v-for="(item,index) of catchdata.list">
									<i class="w" v-if="catchdata.model=='set'" v-on:click="catch_del(index,item)">✕</i>
									<i class="i" v-if="catchdata.model=='get'" v-on:click="catch_get(index,item)">✓</i>
									<span>{{item.time}}</span>
								</div>
							</div>
						</div>
						<div class="areabox" v-if="areabox.show">
							<i class="close" v-on:click="areabox.show=false">✕</i>
							<div class="con">
								<div class="inputbox">
									<textarea class="input" ref="input" v-model="areabox.text" v-bind:placeholder="areabox.hold"></textarea>
								</div>
								<div class="oper">
									<button class="btn imp" v-on:click="areabox_sure">确定</button>
								</div>
							</div>
						</div>
					</div>
				`,
				methods: {
					start(input) {
						this.sort='dsd';
						this.output=[];
						this.input=input;
						let input_td=input.split('\n');
						let input_th=input_td.shift();
						let totaldmg_json={};
						for(let item of input_td){
							let arr=item.split(',');
							if(arr.length>1){
								if(!!!totaldmg_json[arr[1]]){
									totaldmg_json[arr[1]]={
										name:arr[0],
										qty:parseInt(arr[2]),
										dmg:0,
									};
								};
								totaldmg_json[arr[1]].dmg+=parseInt(arr[5]);
							};
						};
						for(let index in totaldmg_json){
							this.output.push({
								id:index,
								name:totaldmg_json[index].name,
								qty:totaldmg_json[index].qty,
								dmg:totaldmg_json[index].dmg,
								avg:totaldmg_json[index].dmg/totaldmg_json[index].qty,
							});
						};
						this.output.sort(function (a,b){
							return b.avg-a.avg;
						});
						for(let index in this.output){
							this.output[index].avgrank=parseInt(index)+1;
						};
						this.output.sort(function (a,b){
							return b.dmg-a.dmg;
						});
						for(let index in this.output){
							this.output[index].dmgrank=parseInt(index)+1;
						};
						if(this.output.length>0){
							this.finish=true;
						};
					},
					dschange(){
						if(this.sort=='dsd'){
							this.sort='dsu';
							this.output.sort(function (a,b){
								return a.dmg-b.dmg;
							});
						}else{
							this.sort='dsd';
							this.output.sort(function (a,b){
								return b.dmg-a.dmg;
							});
						};
					},
					aschange(){
						if(this.sort=='asd'){
							this.sort='asu';
							this.output.sort(function (a,b){
								return a.avg-b.avg;
							});
						}else{
							this.sort='asd';
							this.output.sort(function (a,b){
								return b.avg-a.avg;
							});
						};
					},
					copy(){
						this.iscopy=true;
						setTimeout(()=>{
							window.getSelection().removeAllRanges();
							let range = document.createRange();
							range.selectNode(this.$refs.table);
							window.getSelection().addRange(range);
							document.execCommand("copy");
							window.getSelection().removeAllRanges();
							this.iscopy=false;
							alert('复制了');
						},0);
					},
					copy2(){
						// 获取表格元素
						let table = this.$refs.table;
						// 获取表格行数和列数
						let rows = table.rows.length;
						let cols = table.rows[0].cells.length;
						// 拼接表格数据
						let data = "";
						for (let i = 0; i < rows; i++) {
							for (let j = 0; j < cols; j++) {
								// 获取单元格内容
								let cell = table.rows[i].cells[j].innerText;
								// 添加制表符和换行符
								data += cell + (j < cols - 1 ? "\t" : "\n");
							}
						}
						// 调用navigator.clipboard.writeText()方法，将拼接好的数据写入到剪贴板中
						navigator.clipboard.writeText(data).then(
							function () {
								// 复制成功时执行的回调函数
								alert("复制成功");
							},
							function (err) {
								// 复制失败时执行的回调函数
								alert("复制失败: ", err);
							}
						);
					},
					inp_start(input){
						this.sort='dsd';
						this.output=[];
						let input_td=input.split('\n');
						let input_th=input_td.shift();
						for(let i in input_td){
							let arr=input_td[i].split('\t');
							if(arr.length>1){
								if(i==11){
									this.flag=arr[7];
								};
								this.output.push({
									id:arr[1],
									name:arr[0],
									qty:parseInt(arr[2]),
									dmg:parseInt(arr[3])*1000000,
									dmgrank:parseInt(arr[4]),
									avg:parseInt(arr[5])*1000000,
									avgrank:parseInt(arr[6]),
								});
							};
						};
						this.finish=true;
					},
					dis_start(input){
						let input_td=input.split('\n');
						let input_th=input_td.shift();
						let disoutput=this.output;
						for(let i in input_td){
							let arr=input_td[i].split('\t');
							if(arr.length>1){
								if(i==11){
									this.dis.flag=arr[7];
								};
								let player=disoutput.find((v)=>{return v.id==arr[1]});
								if(!!player){
									player.pdmg=parseInt(arr[3])*1000000;
									player.pdmgrank=parseInt(arr[4]);
									player.pavg=parseInt(arr[5])*1000000;
									player.pavgrank=parseInt(arr[6]);
								};
							};
						};
						this.output=[];
						this.output=disoutput;
					},
					catch_show(model,type){
						this.catchdata.model=model;
						this.catchdata.type=type;
						this.catchdata.show=true;
					},
					catch_add(){
						for(let item of this.output){
							item.pdmg=undefined;
							item.pdmgrank=undefined;
							item.pavg=undefined;
							item.pavgrank=undefined;
						};
						this.catchdata.list.unshift({
							time:JSON.stringify(new Date()).replace(/\"/g, "").replace(/T/g, " ").replace(/Z/g, ""),
							text:JSON.stringify(this.output),
							flag:this.flag,
						});
						localStorage.setItem('catchdata',JSON.stringify(this.catchdata.list));
					},
					catch_del(v,n){
						let bool=confirm('确定要删除'+n.time+'这条记录么？');
						if(bool){
							this.catchdata.list.splice(v, 1);
						};
						localStorage.setItem('catchdata',JSON.stringify(this.catchdata.list));
					},
					catch_get(v,n){
						switch(this.catchdata.type){
							case 'inp' :
							this.output=JSON.parse(n.text);
							this.flag=n.flag;
							this.finish=true;
							this.catchdata.show=false;
							break;
							case 'dis' :
							let input=JSON.parse(n.text);
							for(let item of input){
								let player=this.output.find((v)=>{return v.id==item.id});
								if(!!player){
									player.pdmg=item.dmg;
									player.pdmgrank=item.dmgrank;
									player.pavg=item.avg;
									player.pavgrank=item.avgrank;
								};
							};
							this.dis.flag=n.flag;
							this.catchdata.show=false;
							break;
							default:
							alert('异常操作');
						};
					},
					area_show(type,hold){
						this.areabox.type=type;
						this.areabox.hold=hold;
						this.areabox.text='';
						this.areabox.show=true;
						setTimeout(()=>{
							this.$refs.input.focus();
						},0);
					},
					areabox_sure(){
						if(!!!this.areabox.text){
							return false;
						};
						switch(this.areabox.type){
							case 'inp' :
							this.start(this.areabox.text);
							this.areabox.show=false;
							break;
							case 'tinp' :
							this.inp_start(this.areabox.text);
							this.areabox.show=false;
							break;
							case 'tdis' :
							this.dis_start(this.areabox.text);
							this.areabox.show=false;
							break;
							default:
							alert('异常操作');
						};
					},
				},
				mounted(){
					let c;
					try{
						c=JSON.parse(localStorage.getItem('catchdata'));
					}catch(e){
						c=[];
					}
					if(!!!c){
						c=[];
					};
					this.catchdata.list=c;
				},
			});
		</script>
	</body>
</html>
